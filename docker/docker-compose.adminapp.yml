version: '3.8'

# =============================================================================
# ADMIN APP - Fully Isolated Deployment
# =============================================================================
# Deploy:   docker-compose -f docker-compose.adminapp.yml up -d
# Stop:     docker-compose -f docker-compose.adminapp.yml down
# Rebuild:  docker-compose -f docker-compose.adminapp.yml up -d --build
# Logs:     docker logs -f admin-wildfly
#           docker logs -f admin-frontend
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # ADMIN FRONTEND (Nginx) - Serves AdminPanel UI
  # Accessible via: adminpanel.temcobank.com → Host Nginx → localhost:8089
  # ---------------------------------------------------------------------------
  admin-frontend:
    image: nginx:alpine
    container_name: admin-frontend
    restart: unless-stopped
    ports:
      - "127.0.0.1:8089:80"   # Only localhost, Host Nginx will proxy
    volumes:
      - ./admin-html:/usr/share/nginx/html:ro          # Frontend build
      - ./admin-nginx.conf:/etc/nginx/conf.d/default.conf:ro  # Nginx config
    depends_on:
      - admin-wildfly
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - admin-network

  # ---------------------------------------------------------------------------
  # ADMIN BACKEND (WildFly) - Runs temco-admin.war
  # Internal only - accessed by admin-frontend via Docker network
  # ---------------------------------------------------------------------------
  admin-wildfly:
    build:
      context: .
      dockerfile: Dockerfile.wildfly
    container_name: admin-wildfly
    restart: unless-stopped
    ports:
      - "127.0.0.1:8085:8080"   # HTTP (localhost only for debugging)
      - "127.0.0.1:9992:9990"   # Admin Console (localhost only)
    extra_hosts:
      - "host.docker.internal:host-gateway"   # Allow container to reach host services
    environment:
      - WILDFLY_USER=admin
      - WILDFLY_PASSWORD=admin123
      - DB_HOST=host.docker.internal          # Connect to HOST MariaDB (not container)
      - DB_PORT=3306
      - DB_NAME=temco_system
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD:-temco123}
      - JAVA_OPTS=-Xms512m -Xmx1024m -XX:MetaspaceSize=96M -XX:MaxMetaspaceSize=256m
    volumes:
      - ./deployments/admin:/opt/jboss/wildfly/standalone/deployments
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/temco-admin/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - admin-network
      # Note: temco-network no longer needed since DB is on host

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  admin-maven-repo:

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  # Isolated network for admin containers only
  admin-network:
    driver: bridge
  # Note: temco-network removed - MariaDB runs on host, not in container
